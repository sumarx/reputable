<% content_for :page_title, "Campaign Analytics" %>

<%= render "campaigns/tabs" %>

<div class="space-y-5">
  <turbo-frame id="campaign_analytics_content">
    <%# Header + Filter %>
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div>
        <h1 class="text-xl font-bold text-gray-900">Campaign Analytics</h1>
        <p class="text-sm text-gray-500 mt-0.5">Track how your feedback campaigns are performing</p>
      </div>
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
        <%= render "shared/location_switcher", turbo_frame_id: "campaign_analytics_content" %>
      <%# Period Filter %>
      <div class="flex items-center gap-1 bg-white rounded-xl border border-gray-100 shadow-sm p-1 w-fit">
        <% [["7d", "7 days"], ["30d", "30 days"], ["90d", "90 days"], ["all", "All time"]].each do |key, label| %>
          <%= link_to label, analytics_campaigns_path(period: key, location_id: @current_location&.id),
              data: { turbo_frame: "campaign_analytics_content" },
              class: "px-3 py-1.5 text-xs font-medium rounded-lg transition-all",
              style: @period == key ? "background-color: #4F46E5; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05);" : "color: #6B7280;" %>
        <% end %>
      </div>
      </div>
    </div>

    <%# KPI Cards %>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mt-4">
      <% [
        ["Total Responses", @analytics.total_responses, "#EEF2FF", "#4F46E5", nil],
        ["Redirect Rate", "#{@analytics.conversion_rate}%", "#ECFDF5", "#059669", nil],
        ["Click-through", "#{@analytics.click_through_rate}%", "#EEF2FF", "#4F46E5", nil],
        ["Avg Rating", @analytics.avg_rating, "#FEF3C7", "#D97706", "/5"]
      ].each do |label, value, bg, color, suffix| %>
        <div class="bg-white rounded-xl border border-gray-100 shadow-sm p-5">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center shrink-0" style="background-color: <%= bg %>;">
              <span class="text-lg font-bold" style="color: <%= color %>;"><%= label[0] %></span>
            </div>
            <div>
              <p class="text-xs text-gray-500"><%= label %></p>
              <div class="flex items-baseline gap-1">
                <p class="text-xl font-bold text-gray-900"><%= value %></p>
                <% if suffix %><span class="text-xs text-gray-400"><%= suffix %></span><% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <%# Conversion Funnel %>
    <div class="bg-white rounded-xl border border-gray-100 shadow-sm mt-5">
      <div class="px-5 py-3 border-b border-gray-100">
        <h3 class="text-sm font-semibold text-gray-900">Conversion Funnel</h3>
        <p class="text-xs text-gray-400">From feedback to public review</p>
      </div>
      <div class="p-5">
        <% funnel = @analytics.funnel_data %>
        <% max_val = [funnel[:responses], 1].max %>
        <div class="space-y-3">
          <% [
            ["Responses Collected", funnel[:responses], "#6366F1"],
            ["Redirected to Review", funnel[:redirected], "#10B981"],
            ["Clicked to Post", funnel[:clicked], "#F59E0B"],
            ["Private Feedback", funnel[:private_feedback], "#F43F5E"]
          ].each do |label, value, color| %>
            <div class="flex items-center gap-3">
              <span class="text-sm text-gray-600 w-40 text-right"><%= label %></span>
              <div class="flex-1 rounded-full h-9 overflow-hidden" style="background-color: #F3F4F6;">
                <div class="h-full rounded-full flex items-center justify-end pr-3 transition-all duration-500"
                     style="width: <%= max_val > 0 ? [value.to_f / max_val * 100, 10].max : 10 %>%; background-color: <%= color %>;">
                  <span class="text-sm font-bold text-white"><%= value %></span>
                </div>
              </div>
              <% if funnel[:responses] > 0 && label != "Responses Collected" %>
                <span class="text-xs text-gray-500 w-14 text-right font-medium"><%= (value.to_f / funnel[:responses] * 100).round(1) %>%</span>
              <% else %>
                <span class="w-14"></span>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <%# Charts %>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mt-5">
      <%# Responses Over Time %>
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
        <div class="px-5 py-3 border-b border-gray-100">
          <h3 class="text-sm font-semibold text-gray-900">Responses Over Time</h3>
          <p class="text-xs text-gray-400">Number of campaign responses</p>
        </div>
        <div class="p-4">
          <%= column_chart @analytics.responses_over_time, height: "240px", colors: ["#6366F1"],
              library: { plugins: { legend: { display: false } } } %>
        </div>
      </div>

      <%# Rating Trend %>
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
        <div class="px-5 py-3 border-b border-gray-100">
          <h3 class="text-sm font-semibold text-gray-900">Avg Rating Over Time</h3>
          <p class="text-xs text-gray-400">Average feedback rating trend</p>
        </div>
        <div class="p-4">
          <%= line_chart @analytics.rating_trend, height: "240px", colors: ["#F59E0B"],
              library: { scales: { y: { min: 1, max: 5 } }, plugins: { legend: { display: false } } } %>
        </div>
      </div>

      <%# Rating Distribution %>
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
        <div class="px-5 py-3 border-b border-gray-100">
          <h3 class="text-sm font-semibold text-gray-900">Rating Distribution</h3>
          <p class="text-xs text-gray-400">Breakdown by star rating</p>
        </div>
        <div class="p-5">
          <% rating_data = @analytics.responses_by_rating %>
          <% total_ratings = rating_data.values.sum %>
          <div class="space-y-3">
            <% (1..5).reverse_each do |star| %>
              <% count = rating_data[star] || 0 %>
              <% pct = total_ratings > 0 ? (count.to_f / total_ratings * 100).round(1) : 0 %>
              <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-gray-600 w-8 text-right"><%= star %> ★</span>
                <div class="flex-1 rounded-full h-6 overflow-hidden" style="background-color: #F3F4F6;">
                  <% bar_color = star >= 4 ? '#6366F1' : star == 3 ? '#FBBF24' : '#FB7185' %>
                  <div class="h-full rounded-full" style="width: <%= [pct, 3].max %>%; background-color: <%= bar_color %>;"></div>
                </div>
                <span class="text-sm text-gray-500 w-20 text-right"><%= count %> (<%= pct %>%)</span>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <%# Hourly Distribution %>
      <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
        <div class="px-5 py-3 border-b border-gray-100">
          <h3 class="text-sm font-semibold text-gray-900">Response Time of Day</h3>
          <p class="text-xs text-gray-400">When customers give feedback</p>
        </div>
        <div class="p-4">
          <% hourly = @analytics.hourly_distribution.transform_keys { |h| "#{h.to_i.to_s.rjust(2, '0')}:00" } %>
          <%= column_chart hourly, height: "240px", colors: ["#A855F7"],
              library: { plugins: { legend: { display: false } } } %>
        </div>
      </div>
    </div>

    <%# Campaign Comparison Table %>
    <div class="bg-white rounded-xl border border-gray-100 shadow-sm mt-5">
      <div class="px-5 py-3 border-b border-gray-100">
        <h3 class="text-sm font-semibold text-gray-900">Campaign Comparison</h3>
        <p class="text-xs text-gray-400">Side-by-side performance</p>
      </div>

      <% campaign_stats = @analytics.responses_by_campaign %>
      <% if campaign_stats.any? %>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-100" style="background-color: #F9FAFB;">
                <th class="text-left px-5 py-3 text-xs text-gray-500 font-semibold uppercase tracking-wider">Campaign</th>
                <th class="text-left px-4 py-3 text-xs text-gray-500 font-semibold uppercase tracking-wider">Location</th>
                <th class="text-center px-4 py-3 text-xs text-gray-500 font-semibold uppercase tracking-wider">Responses</th>
                <th class="text-center px-4 py-3 text-xs text-gray-500 font-semibold uppercase tracking-wider">Redirected</th>
                <th class="text-center px-4 py-3 text-xs text-gray-500 font-semibold uppercase tracking-wider">Clicked</th>
                <th class="text-center px-4 py-3 text-xs text-gray-500 font-semibold uppercase tracking-wider">Conversion</th>
                <th class="text-center px-4 py-3 text-xs text-gray-500 font-semibold uppercase tracking-wider">Rating</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-50">
              <% campaign_stats.each do |cs| %>
                <tr class="hover:bg-gray-50/50">
                  <td class="px-5 py-3">
                    <div class="flex items-center gap-2">
                      <% if cs[:campaign].active? %>
                        <span class="w-2 h-2 rounded-full shrink-0" style="background-color: #10B981;"></span>
                      <% else %>
                        <span class="w-2 h-2 rounded-full shrink-0" style="background-color: #D1D5DB;"></span>
                      <% end %>
                      <%= link_to cs[:campaign].name, campaign_path(cs[:campaign]), class: "font-medium text-gray-900 hover:text-indigo-600", data: { turbo_frame: "_top" } %>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-gray-500"><%= cs[:campaign].location.name %></td>
                  <td class="text-center px-4 py-3 font-semibold text-gray-900"><%= cs[:responses] %></td>
                  <td class="text-center px-4 py-3 font-medium" style="color: #059669;"><%= cs[:redirected] %></td>
                  <td class="text-center px-4 py-3 font-medium" style="color: #4F46E5;"><%= cs[:clicked] %></td>
                  <td class="text-center px-4 py-3">
                    <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-semibold"
                          style="background-color: <%= cs[:conversion_rate] >= 70 ? '#ECFDF5' : cs[:conversion_rate] >= 40 ? '#FFFBEB' : '#FFF1F2' %>; color: <%= cs[:conversion_rate] >= 70 ? '#059669' : cs[:conversion_rate] >= 40 ? '#92400E' : '#E11D48' %>;">
                      <%= cs[:conversion_rate] %>%
                    </span>
                  </td>
                  <td class="text-center px-4 py-3">
                    <span class="text-amber-500"><%= '★' * cs[:avg_rating].round %><%= '☆' * (5 - cs[:avg_rating].round) %></span>
                    <span class="text-gray-400 ml-1 text-xs"><%= cs[:avg_rating] %></span>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="p-8 text-center">
          <p class="text-sm text-gray-400">No campaign responses in this period</p>
        </div>
      <% end %>
    </div>

    <%# Recent Feedback %>
    <div class="bg-white rounded-xl border border-gray-100 shadow-sm mt-5">
      <div class="px-5 py-3 border-b border-gray-100">
        <h3 class="text-sm font-semibold text-gray-900">Recent Feedback</h3>
        <p class="text-xs text-gray-400">Latest customer comments</p>
      </div>

      <% feedback = @analytics.top_feedback %>
      <% if feedback.any? %>
        <div class="divide-y divide-gray-50">
          <% feedback.each do |response| %>
            <div class="px-5 py-4">
              <div class="flex items-start justify-between gap-3 mb-1.5">
                <div class="flex items-center gap-2.5">
                  <span class="w-2.5 h-2.5 rounded-full shrink-0" style="background-color: <%= response.rating >= response.campaign.positive_threshold ? '#10B981' : '#F43F5E' %>;"></span>
                  <span class="text-sm font-semibold text-gray-900"><%= response.customer_name || "Anonymous" %></span>
                </div>
                <span class="text-sm text-amber-500 shrink-0"><%= '★' * (response.rating || 0) %><%= '☆' * (5 - (response.rating || 0)) %></span>
              </div>
              <p class="text-sm text-gray-600 ml-5 mb-1.5"><%= response.feedback %></p>
              <p class="text-xs text-gray-400 ml-5"><%= response.campaign.name %> · <%= response.campaign.location.name %> · <%= time_ago_in_words(response.created_at) %> ago</p>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="p-8 text-center">
          <p class="text-sm text-gray-400">No feedback with comments yet</p>
        </div>
      <% end %>
    </div>
  </turbo-frame>
</div>
