<% content_for(:title) { "Reply Inbox ‚Äî RepuTable" } %>

<div class="max-w-3xl mx-auto">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Reply Inbox</h1>
    <p class="text-sm text-gray-500 mt-1">
      <span class="font-semibold" style="color: #4f46e5;"><%= @pending_count %></span> reviews awaiting reply
    </p>
  </div>

  <!-- Filter Tabs -->
  <%= turbo_frame_tag "inbox_content" do %>
    <div class="flex space-x-1 mb-6 bg-gray-100 rounded-lg p-1 overflow-x-auto">
      <% [
        ["needs_reply", "‚è≥ Needs Reply"],
        ["drafted", "‚úèÔ∏è Drafted"],
        ["sent", "‚úÖ Sent"],
        ["all", "All"]
      ].each do |key, label| %>
        <%= link_to reply_inbox_path(tab: key),
              class: "px-3 py-2 text-sm font-medium rounded-md whitespace-nowrap transition-colors #{@tab == key ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-500 hover:text-gray-900'}",
              data: { turbo_frame: "inbox_content" } do %>
          <%= label %>
        <% end %>
      <% end %>
    </div>

    <!-- Review Cards -->
    <% if @reviews.empty? %>
      <div class="text-center py-16 bg-white rounded-xl border border-gray-200">
        <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="mt-3 text-sm font-semibold text-gray-900">All caught up!</h3>
        <p class="mt-1 text-sm text-gray-500">No reviews in this category.</p>
      </div>
    <% else %>
      <div class="space-y-4">
        <% @reviews.each do |review| %>
          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <!-- Review Card -->
            <div class="p-4">
              <!-- Top row: sentiment + rating + location + status -->
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2 flex-wrap">
                  <% badge_styles = {
                    "positive" => "background-color: #dcfce7; color: #166534;",
                    "negative" => "background-color: #fee2e2; color: #991b1b;",
                  } %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                        style="<%= badge_styles[review.sentiment] || 'background-color: #f3f4f6; color: #374151;' %>">
                    <%= review.sentiment&.capitalize || "‚Äî" %>
                  </span>
                  <% if review.rating %>
                    <span class="text-xs" style="color: #d97706;"><%= "‚òÖ" * review.rating %><%= "‚òÜ" * (5 - review.rating) %></span>
                  <% end %>
                  <span class="text-xs text-gray-400">üìç <%= review.location.name %></span>
                </div>
                <% status_styles = {
                  "sent" => "background-color: #dcfce7; color: #166534;",
                  "manual" => "background-color: #dbeafe; color: #1e40af;",
                  "draft" => "background-color: #fef3c7; color: #92400e;",
                } %>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                      style="<%= status_styles[review.reply_status] || 'background-color: #f3f4f6; color: #6b7280;' %>">
                  <%= review.reply_status.capitalize %>
                </span>
              </div>

              <!-- Reviewer + time -->
              <div class="flex items-center gap-2 mb-1.5">
                <span class="text-sm font-semibold text-gray-900"><%= review.reviewer_name || "Anonymous" %></span>
                <span class="text-xs text-gray-400"><%= time_ago_in_words(review.published_at || review.created_at) %> ago</span>
              </div>

              <!-- Review text -->
              <p class="text-sm text-gray-600 leading-relaxed"><%= truncate(review.body || "No review text", length: 200) %></p>
            </div>

            <!-- Reply Drafts -->
            <% drafts = review.reply_drafts.where(status: %w[draft approved]).order(:created_at) %>
            <% if drafts.any? %>
              <div class="border-t border-gray-100 bg-gray-50 px-4 py-3">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">
                  AI Replies (<%= drafts.count %>)
                </p>
                <div class="space-y-3">
                  <% drafts.each do |draft| %>
                    <div class="bg-white rounded-lg border border-gray-200 p-3">
                      <!-- Reply text (truncated for scanning) -->
                      <p class="text-sm text-gray-700 leading-relaxed mb-3"><%= truncate(draft.body, length: 250) %></p>

                      <!-- Action buttons -->
                      <div class="flex items-center gap-2 flex-wrap">
                        <% if draft.draft? %>
                          <%= button_to approve_reply_draft_path(draft, redirect_to: reply_inbox_path(tab: @tab)), method: :post,
                                class: "inline-flex items-center px-3 py-1.5 text-xs font-semibold rounded-lg text-white transition-opacity hover:opacity-90",
                                style: "background-color: #059669;" do %>
                            ‚úì Approve
                          <% end %>
                          <%= button_to reply_draft_path(draft, redirect_to: reply_inbox_path(tab: @tab)),
                                method: :patch,
                                params: { reply_draft: { status: "rejected" } },
                                class: "inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-lg text-gray-500 bg-gray-100 hover:bg-gray-200 transition-colors" do %>
                            Dismiss
                          <% end %>
                        <% elsif draft.approved? %>
                          <span class="text-xs font-medium px-2 py-1 rounded-lg" style="background-color: #dcfce7; color: #166534;">‚úì Approved</span>
                          <%= button_to send_reply_reply_draft_path(draft), method: :post,
                                class: "inline-flex items-center px-3 py-1.5 text-xs font-semibold rounded-lg text-white transition-opacity hover:opacity-90",
                                style: "background-color: #4f46e5;" do %>
                            Send Reply
                          <% end %>
                          <button onclick="navigator.clipboard.writeText(this.dataset.text).then(() => { let s=this.querySelector('span'); s.textContent='Copied!'; setTimeout(() => s.textContent='üìã Copy', 1500); })"
                                  data-text="<%= draft.body %>"
                                  class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-lg text-gray-500 bg-gray-100 hover:bg-gray-200 transition-colors cursor-pointer">
                            <span>üìã Copy</span>
                          </button>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% elsif review.body.present? && !review.replied? %>
              <div class="border-t border-gray-100 bg-gray-50 px-4 py-4 text-center">
                <%= button_to generate_reply_review_path(review, redirect_to: reply_inbox_path(tab: "drafted")), method: :post,
                      class: "inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-white transition-opacity hover:opacity-90",
                      style: "background-color: #4f46e5;" do %>
                  ü§ñ Generate AI Replies
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Pagination -->
      <% if @pagy.last > 1 %>
        <div class="mt-6 flex items-center justify-between">
          <span class="text-sm text-gray-500">Page <%= @pagy.page %> of <%= @pagy.last %></span>
          <div class="flex items-center gap-2">
            <% if @pagy.page > 1 %>
              <%= link_to "‚Üê Prev", reply_inbox_path(page: @pagy.page - 1, tab: @tab), class: "px-3 py-1.5 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
            <% end %>
            <% if @pagy.page < @pagy.last %>
              <%= link_to "Next ‚Üí", reply_inbox_path(page: @pagy.page + 1, tab: @tab), class: "px-3 py-1.5 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>
