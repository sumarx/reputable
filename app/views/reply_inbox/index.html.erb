<% content_for(:title) { "Reply Inbox ‚Äî RepuTable" } %>

<div class="max-w-5xl mx-auto">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Reply Inbox</h1>
      <p class="text-sm text-gray-500 mt-1">
        <span class="font-semibold" style="color: #4f46e5;"><%= @pending_count %></span> reviews awaiting reply
      </p>
    </div>
  </div>

  <!-- Filter Tabs -->
  <%= turbo_frame_tag "inbox_content" do %>
    <div class="flex space-x-1 mb-6 bg-gray-100 rounded-lg p-1 w-fit">
      <% [
        ["needs_reply", "Needs Reply"],
        ["drafted", "Drafted"],
        ["sent", "Sent"],
        ["all", "All"]
      ].each do |key, label| %>
        <%= link_to reply_inbox_path(tab: key),
              class: "px-4 py-2 text-sm font-medium rounded-md transition-colors #{@tab == key ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:text-gray-900'}",
              data: { turbo_frame: "inbox_content" } do %>
          <%= label %>
        <% end %>
      <% end %>
    </div>

    <!-- Review Cards -->
    <% if @reviews.empty? %>
      <div class="text-center py-16 bg-white rounded-xl border border-gray-200">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="mt-3 text-sm font-semibold text-gray-900">All caught up!</h3>
        <p class="mt-1 text-sm text-gray-500">No reviews in this category.</p>
      </div>
    <% else %>
      <div class="space-y-4">
        <% @reviews.each do |review| %>
          <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
            <!-- Review Header -->
            <div class="p-5">
              <div class="flex items-start justify-between">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-3 mb-2">
                    <!-- Sentiment badge -->
                    <% badge_color = case review.sentiment
                      when "positive" then "background-color: #dcfce7; color: #166534;"
                      when "negative" then "background-color: #fee2e2; color: #991b1b;"
                      else "background-color: #f3f4f6; color: #374151;"
                    end %>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="<%= badge_color %>">
                      <%= review.sentiment&.capitalize || "Unknown" %>
                    </span>
                    <!-- Rating -->
                    <% if review.rating %>
                      <span class="text-sm" style="color: #d97706;"><%= review.star_rating %></span>
                    <% end %>
                    <!-- Location -->
                    <span class="text-xs text-gray-500">üìç <%= review.location.name %></span>
                  </div>

                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-sm font-semibold text-gray-900"><%= review.reviewer_name || "Anonymous" %></span>
                    <span class="text-xs text-gray-400"><%= time_ago_in_words(review.published_at || review.created_at) %> ago</span>
                  </div>

                  <p class="text-sm text-gray-700 line-clamp-3"><%= review.body || "No review text" %></p>
                </div>

                <!-- Status badge -->
                <div class="ml-4 flex-shrink-0">
                  <% status_style = case review.reply_status
                    when "sent" then "background-color: #dcfce7; color: #166534;"
                    when "manual" then "background-color: #dbeafe; color: #1e40af;"
                    when "draft" then "background-color: #fef3c7; color: #92400e;"
                    else "background-color: #f3f4f6; color: #6b7280;"
                  end %>
                  <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium" style="<%= status_style %>">
                    <%= review.reply_status.capitalize %>
                  </span>
                </div>
              </div>
            </div>

            <!-- Reply Drafts Section -->
            <% drafts = review.reply_drafts.order(:created_at) %>
            <% if drafts.any? %>
              <div class="border-t border-gray-100 bg-gray-50 p-5">
                <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">
                  AI-Generated Replies (<%= drafts.count %>)
                </h4>
                <div class="space-y-3">
                  <% drafts.each do |draft| %>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                      <div class="flex items-start justify-between gap-3">
                        <p class="text-sm text-gray-700 flex-1"><%= draft.body %></p>
                        <div class="flex-shrink-0 flex items-center gap-2">
                          <% if draft.draft? %>
                            <%= button_to approve_reply_draft_path(draft), method: :post,
                                  class: "inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-white hover:opacity-90 transition-opacity",
                                  style: "background-color: #059669;" do %>
                              ‚úì Approve
                            <% end %>
                            <%= button_to reply_draft_path(draft), method: :patch,
                                  params: { reply_draft: { status: "rejected" } },
                                  class: "inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors" do %>
                              ‚úó
                            <% end %>
                          <% elsif draft.approved? %>
                            <span class="text-xs font-medium px-2 py-1 rounded" style="background-color: #dcfce7; color: #166534;">Approved</span>
                            <%= button_to send_reply_reply_draft_path(draft), method: :post,
                                  class: "inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-white hover:opacity-90 transition-opacity",
                                  style: "background-color: #4f46e5;" do %>
                              Send Reply
                            <% end %>
                            <button onclick="navigator.clipboard.writeText(this.dataset.text).then(() => { this.textContent = 'Copied!'; setTimeout(() => this.textContent = 'üìã Copy', 1500); })"
                                    data-text="<%= draft.body %>"
                                    class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 bg-gray-100 hover:bg-gray-200 transition-colors">
                              üìã Copy
                            </button>
                          <% else %>
                            <span class="text-xs text-gray-400">Rejected</span>
                          <% end %>
                        </div>
                      </div>
                      <div class="mt-2 flex items-center gap-2">
                        <span class="text-xs text-gray-400">Tone: <%= draft.tone.capitalize %></span>
                        <span class="text-xs text-gray-400">‚Ä¢</span>
                        <span class="text-xs text-gray-400"><%= draft.status.capitalize %></span>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% elsif review.body.present? && !review.replied? %>
              <div class="border-t border-gray-100 bg-gray-50 p-5 text-center">
                <%= button_to generate_reply_review_path(review), method: :post,
                      class: "inline-flex items-center px-4 py-2 text-sm font-medium rounded-lg text-white hover:opacity-90 transition-opacity",
                      style: "background-color: #4f46e5;" do %>
                  ü§ñ Generate AI Replies
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Pagination -->
      <div class="mt-6">
        <%== pagy_nav(@pagy) if @pagy.pages > 1 %>
      </div>
    <% end %>
  <% end %>
</div>
